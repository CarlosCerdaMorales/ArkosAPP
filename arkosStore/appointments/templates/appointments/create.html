{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'appointments/create.css' %}">
<link rel="stylesheet" href="{% static 'accounts/profile.css' %}">
{% endblock %}

{% block content %}

<div class="profile-wrapper">
    <h2 class="profile-title">Reservar Cita</h2>

    <div class="profile-card" style="text-align: left;">
        
        <div class="profile-field">
            <label for="ui-service">1. Selecciona el servicio</label>
            <select id="ui-service" class="input" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">-- Elige una opción --</option>
                {% for service in services %}
                    <option value="{{ service.id }}" data-duration="{{ service.duration }}" {% if form.service.value|stringformat:"s" == service.id|stringformat:"s" %}selected{% endif %}>
                        {{ service.get_name_display }} ({{ service.duration }} min)
                    </option>
                {% endfor %}
            </select>
        </div>

        <div id="step-2-container" class="profile-field {% if not form.service.value %}step-hidden{% endif %}">
            <label for="ui-date">2. Elige una fecha</label>
            <input type="date" id="ui-date" class="input" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc;" 
                   value="{{ form.date.value|default:'' }}">
        </div>

        <div id="step-3-container" class="profile-field {% if not form.date.value %}step-hidden{% endif %}">
            <label>3. Horas disponibles</label>
            <div id="slots-grid" class="slot-container">
                </div>
            <p id="feedback-msg" class="loading-text" style="margin-top:10px;"></p>
        </div>

        {% if not user.is_authenticated or force_guest %}
        <div id="guest-info-container" class="profile-field {% if not form.errors %}step-hidden{% endif %}" 
             style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
            
            <h3 style="font-size: 1.1em; color: #00373E; margin-bottom: 15px;">
                {% if force_guest %}Datos del Cliente{% else %}Tus datos de contacto{% endif %}
            </h3>
            
            {% if form.non_field_errors %}
                <div style="color: #d9534f; margin-bottom: 10px; font-size: 0.9em;">{{ form.non_field_errors }}</div>
            {% endif %}

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>Nombre *</label>
                    <input type="text" name="guest_first_name" form="real-django-form" class="input" required placeholder="Nombre"
                           value="{{ form.guest_first_name.value|default:'' }}">
                    <div style="color: #d9534f; font-size: 0.85em; margin-top: 4px;">{{ form.guest_first_name.errors }}</div>
                </div>
                <div>
                    <label>Apellidos *</label>
                    <input type="text" name="guest_last_name" form="real-django-form" class="input" required placeholder="Apellidos"
                           value="{{ form.guest_last_name.value|default:'' }}">
                    <div style="color: #d9534f; font-size: 0.85em; margin-top: 4px;">{{ form.guest_last_name.errors }}</div>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <label>Email *</label>
                <input type="email" name="guest_email" form="real-django-form" class="input" required placeholder="tu@email.com"
                       value="{{ form.guest_email.value|default:'' }}">
                <div style="color: #d9534f; font-size: 0.85em; margin-top: 4px;">{{ form.guest_email.errors }}</div>
            </div>
            <div style="margin-top: 15px;">
                <label>Teléfono *</label>
                <input type="tel" name="guest_phone" form="real-django-form" class="input" required placeholder="+34 600000000"
                       value="{{ form.guest_phone.value|default:'' }}">
                <div style="color: #d9534f; font-size: 0.85em; margin-top: 4px;">{{ form.guest_phone.errors }}</div>
            </div>
        </div>
        {% endif %}

        <form method="post" id="real-django-form">
            {% csrf_token %}
            {{ form.service }} 
            {{ form.date }}
            {{ form.time }}
            <input type="hidden" name="worker_id" id="hidden_worker_id" value="{{ form.data.worker_id|default:'' }}">
        </form>

        <div class="profile-form-actions">
            <button type="button" id="confirm-btn" class="profile-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                Confirmar Reserva
            </button>
        </div>

    </div>
</div>

<div class="confirm-modal-overlay" id="conflictModal" style="display: none;">
    <div class="confirm-modal">
        <div class="confirm-title" style="color: #d9534f;">⚠️ ¡Atención!</div>
        <div class="confirm-text">
            Ya tienes otra cita programada que coincide o se solapa con este horario.
            <br><br>
            ¿Deseas reservar de todas formas?
        </div>
        <div class="confirm-btns">
            <button class="modal-btn modal-btn-cancel" id="modalCancelBtn">Revisar hora</button>
            <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Reservar igual</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const uiService = document.getElementById('ui-service');
    const uiDate = document.getElementById('ui-date');
    const step2 = document.getElementById('step-2-container');
    const step3 = document.getElementById('step-3-container');
    const guestContainer = document.getElementById('guest-info-container'); 
    const slotsGrid = document.getElementById('slots-grid');
    const feedbackMsg = document.getElementById('feedback-msg');
    const confirmBtn = document.getElementById('confirm-btn');

    const hiddenService = document.querySelector('[name="service"]');
    const hiddenDate = document.querySelector('[name="date"]');
    const hiddenTime = document.querySelector('[name="time"]');
    const hiddenWorker = document.getElementById('hidden_worker_id');
    const realForm = document.getElementById('real-django-form');

    const conflictModal = document.getElementById('conflictModal');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');

    const today = new Date();
    const todayISO = today.toISOString().split('T')[0];
    uiDate.setAttribute('min', todayISO);

    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 30);
    const maxDateISO = maxDate.toISOString().split('T')[0];
    uiDate.setAttribute('max', maxDateISO);

    // --- FUNCIÓN REUTILIZABLE PARA CARGAR HUECOS ---
    function fetchAndRenderSlots(serviceId, dateVal) {
        if (!serviceId || !dateVal) return;

        // UI Reset parcial
        feedbackMsg.innerText = 'Buscando disponibilidad...';
        slotsGrid.innerHTML = '';
        
        // Recuperamos valores previos si existen (para la recarga tras error)
        // Usamos 'Slice' para quitar segundos si vienen (09:00:00 -> 09:00)
        const preSelectedTime = hiddenTime.value ? hiddenTime.value.slice(0, 5) : null; 
        const preSelectedWorker = hiddenWorker.value;

        fetch(`/appointments/api/get-available-slots/?service_id=${serviceId}&date=${dateVal}`)
            .then(response => {
                if (!response.ok) throw new Error('Error en la red');
                return response.json();
            })
            .then(data => {
                feedbackMsg.innerText = '';
                
                if (data.slots.length === 0) {
                    feedbackMsg.innerText = 'No hay huecos disponibles para este día. Prueba otra fecha.';
                    return;
                }

                data.slots.forEach(slot => {
                    const btn = document.createElement('div');
                    btn.className = 'time-slot';
                    btn.innerHTML = `<strong>${slot.time_display}</strong><br><small>${slot.worker_name}</small>`;
                    
                    if (preSelectedTime === slot.time_value && preSelectedWorker == slot.worker_id) {
                        btn.classList.add('selected');
                        confirmBtn.disabled = false;
                        confirmBtn.style.opacity = '1';
                        confirmBtn.style.cursor = 'pointer';
                        if (guestContainer) {
                            guestContainer.classList.remove('step-hidden');
                            guestContainer.classList.add('step-visible');
                        }
                    }

                    btn.onclick = function() {
                        document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');

                        hiddenTime.value = slot.time_value;
                        hiddenWorker.value = slot.worker_id; 
                        
                        if (guestContainer) {
                            guestContainer.classList.remove('step-hidden');
                            guestContainer.classList.add('step-visible');
                        }

                        confirmBtn.disabled = false;
                        confirmBtn.style.opacity = '1';
                        confirmBtn.style.cursor = 'pointer';
                    };
                    
                    slotsGrid.appendChild(btn);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                feedbackMsg.innerText = 'Ocurrió un error al cargar los horarios.';
            });
    }


    uiService.addEventListener('change', function() {
        const serviceId = this.value;
        uiDate.value = '';
        slotsGrid.innerHTML = '';
        step3.classList.add('step-hidden');
        if(guestContainer) guestContainer.classList.add('step-hidden');
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
        confirmBtn.style.cursor = 'not-allowed';

        if (serviceId) {
            hiddenService.value = serviceId;
            step2.classList.remove('step-hidden');
            step2.classList.add('step-visible');
        } else {
            step2.classList.add('step-hidden');
        }
    });

    uiDate.addEventListener('change', function() {
        const dateVal = this.value;
        const serviceId = uiService.value;
        
        const selectedDate = new Date(dateVal);
        if (selectedDate > maxDate) {
            feedbackMsg.innerText = 'No puedes reservar con más de 30 días de antelación.';
            slotsGrid.innerHTML = '';
            confirmBtn.disabled = true;
            step3.classList.add('step-hidden');
            return;
        }

        if (!dateVal || !serviceId) return;

        hiddenDate.value = dateVal;
        step3.classList.remove('step-hidden');
        
        fetchAndRenderSlots(serviceId, dateVal);
    });

    if (hiddenService.value && hiddenDate.value) {
        fetchAndRenderSlots(hiddenService.value, hiddenDate.value);
    }

    confirmBtn.addEventListener('click', function(e) {
        e.preventDefault(); 

        if (!realForm.reportValidity()) return; 

        const sId = hiddenService.value;
        const dVal = hiddenDate.value;
        const tVal = hiddenTime.value;

        if (!tVal) {
            alert("Por favor, selecciona una hora.");
            return;
        }

        confirmBtn.disabled = true;
        confirmBtn.innerText = "Verificando agenda...";

        fetch(`/appointments/api/check-conflict/?service_id=${sId}&date=${dVal}&time=${tVal}`)
            .then(r => r.json())
            .then(data => {
                if (data.conflict) {
                    conflictModal.style.display = 'flex';
                    confirmBtn.innerText = "Confirmar Reserva";
                    confirmBtn.disabled = false;
                } else {
                    realForm.submit();
                }
            })
            .catch(err => {
                console.error(err);
                realForm.submit();
            });
    });

    modalConfirmBtn.addEventListener('click', function() {
        realForm.submit();
    });

    modalCancelBtn.addEventListener('click', function() {
        conflictModal.style.display = 'none';
    });
});
</script>

{% endblock %}