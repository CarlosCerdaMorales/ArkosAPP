{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'appointments/create.css' %}">
{% endblock %}

{% block content %}

<div class="profile-wrapper">
    <h2 class="profile-title">Reservar Cita</h2>

    <div class="profile-card"> 
        
        <div class="profile-field">
            <label for="ui-service">1. Selecciona el servicio</label>
            <select id="ui-service" class="input"> 
                <option value="">-- Elige una opción --</option>
                {% for service in services %}
                    <option value="{{ service.id }}" data-duration="{{ service.duration }}">
                        {{ service.get_name_display }} (sesión de {{ service.duration }} min)
                    </option>
                {% endfor %}
            </select>
        </div>

        <div id="step-2-container" class="profile-field">
            <label for="ui-date">2. Elige una fecha</label>
            <input type="date" id="ui-date" class="input">
        </div>

        <div id="step-3-container" class="profile-field step-hidden">
            <label>3. Horas disponibles</label>
            <div id="slots-grid" class="slot-container">
                </div>
            <p id="feedback-msg" class="loading-text"></p>
        </div>

        <form method="post" id="real-django-form">
            {% csrf_token %}
            {{ form.service }} 
            {{ form.date }}
            {{ form.time }}
            <input type="hidden" name="worker_id" id="hidden_worker_id">
        </form>

        <div class="profile-form-actions">
            <button type="button" id="confirm-btn" class="profile-btn" disabled>
                Confirmar Reserva
            </button>
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const uiService = document.getElementById('ui-service');
    const uiDate = document.getElementById('ui-date');
    const step2 = document.getElementById('step-2-container');
    const step3 = document.getElementById('step-3-container');
    const slotsGrid = document.getElementById('slots-grid');
    const feedbackMsg = document.getElementById('feedback-msg');
    const confirmBtn = document.getElementById('confirm-btn');

    const hiddenService = document.querySelector('[name="service"]');
    const hiddenDate = document.querySelector('[name="date"]');
    const hiddenTime = document.querySelector('[name="time"]');
    const hiddenWorker = document.getElementById('hidden_worker_id');
    const realForm = document.getElementById('real-django-form');

    const today = new Date();
    const todayISO = today.toISOString().split('T')[0];
    uiDate.setAttribute('min', todayISO);

    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 30);
    const maxDateISO = maxDate.toISOString().split('T')[0];
    uiDate.setAttribute('max', maxDateISO);

    uiService.addEventListener('change', function() {
        const serviceId = this.value;

        uiDate.value = '';
        slotsGrid.innerHTML = '';
        
        // El paso 2 es ahora visible por defecto, lo ocultamos si no hay servicio
        step2.classList.remove('step-visible'); 
        step3.classList.remove('step-visible'); 

        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
        confirmBtn.style.cursor = 'not-allowed';

        if (serviceId) {
            hiddenService.value = serviceId;
            step2.classList.add('step-visible'); // Hacemos visible el paso 2 con la clase CSS
        } else {
            // Si no hay servicio, aseguramos que el paso 2 se oculte (aunque ya lo hace por defecto si no añadimos step-visible)
            step2.classList.remove('step-visible');
        }
    });

    uiDate.addEventListener('change', function() {
        const dateVal = this.value;
        const serviceId = uiService.value;

        const selectedDate = new Date(dateVal)

        if (selectedDate > maxDate) {
            feedbackMsg.innerText = 'No puedes reservar con más de 30 días de antelación.';
            slotsGrid.innerHTML = '';
            confirmBtn.disabled = true;
            step3.classList.remove('step-visible'); // Ocultar paso 3 si falla la validación
            return;
        }

        if (!dateVal || !serviceId) return;

        hiddenDate.value = dateVal;

        // Usamos la clase para mostrar el paso 3 (Hora)
        step3.classList.add('step-visible');
        slotsGrid.innerHTML = '';
        feedbackMsg.innerText = 'Buscando disponibilidad...';
        confirmBtn.disabled = true;

        fetch(`/appointments/api/get-available-slots/?service_id=${serviceId}&date=${dateVal}`)
            .then(response => {
                if (!response.ok) throw new Error('Error en la red');
                return response.json();
            })
            .then(data => {
                feedbackMsg.innerText = '';
                
                if (data.slots.length === 0) {
                    feedbackMsg.innerText = 'No hay huecos disponibles para este día. Prueba otra fecha.';
                    return;
                }

                data.slots.forEach(slot => {
                    const btn = document.createElement('div');
                    btn.className = 'time-slot';
                    btn.innerHTML = `<strong>${slot.time_display}</strong><br><small>${slot.worker_name}</small>`;
                    
                    btn.onclick = function() {
                        document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');

                        hiddenTime.value = slot.time_value;
                        hiddenWorker.value = slot.worker_id; 
                        
                        confirmBtn.disabled = false;
                        confirmBtn.style.opacity = '1';
                        confirmBtn.style.cursor = 'pointer';
                    };
                    
                    slotsGrid.appendChild(btn);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                feedbackMsg.innerText = 'Ocurrió un error al cargar los horarios.';
            });
    });

    confirmBtn.addEventListener('click', function() {
        realForm.submit();
    });
});
</script>

{% endblock %}